<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIELIT O-Level Practical Exam Simulator</title>

    <!-- External Libraries: Font Awesome for Icons & CodeMirror for Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/eclipse.min.css">

    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --primary-color: #0056a3;
            --secondary-color: #f37021;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --review-color: #6f42c1;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #343a40;
            --bg-color: #ffffff;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --transition-speed: 0.3s;
        }

        /* Universal Box Sizing for better layout control */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: var(--text-color);
            margin: 0;
            font-size: 16px;
            overflow-x: hidden;
        }

        /* --- Page Container --- */
        .page { display: none; }
        .page.active { display: block; }

        /* --- Authentication & Instructions Pages --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            animation: fadeIn 0.5s ease-in-out;
        }

        .auth-card {
            width: 100%;
            max-width: 480px;
            background: var(--bg-color);
            padding: 2.2rem 2.5rem; /* Adjusted padding */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border-top: 5px solid var(--primary-color);
        }

        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header img { max-width: 180px; margin-bottom: 1rem; }
        .auth-header h2 { color: var(--primary-color); font-weight: 700; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; /* Adjusted margin */ font-weight: 600; }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 86, 163, 0.2);
        }
        .error-message { color: var(--danger-color); font-size: 0.875rem; min-height: 1.2em; margin-top: 0.25rem; }

        /* --- Buttons --- */
        .btn {
            padding: 12px 24px; border: none; border-radius: var(--border-radius); font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: all var(--transition-speed);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); box-shadow: none; }
        .btn:disabled { background-color: var(--medium-gray); color: var(--dark-gray); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #00417c; }
        .btn-secondary { background-color: var(--dark-gray); color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #6c757d; color: white; }
        .btn-warning:hover { background-color: #5a6268; }
        .btn-full { width: 100%; }
        .btn-icon { background: transparent; border: 1px solid #ccc; color: var(--text-color); padding: 8px 10px; }
        .btn-icon:hover { background-color: var(--medium-gray); transform: none; box-shadow: none; }

        /* --- Instructions Page --- */
        .instructions-card { max-width: 750px; }
        .instruction-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 1.25rem; /* Adjusted margin */ }
        .instruction-item i { font-size: 1.5rem; color: var(--primary-color); margin-top: 4px; width: 25px; text-align: center; }
        .instructions-footer { text-align: center; border-top: 1px solid var(--medium-gray); padding-top: 1.5rem; margin-top: 1.5rem; }
        .form-check { margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* --- Exam Page Layout --- */
        #exam-page { display: none; flex-direction: column; height: 100vh; animation: fadeIn 0.5s; }
        #exam-page.active { display: flex; }
        .exam-header {
            display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-color);
            padding: 0.6rem 1.25rem; /* Adjusted padding */ box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .exam-header .logo { display: flex; align-items: center; gap: 15px; }
        .exam-header .logo img { height: 40px; }
        .exam-header .logo span { font-weight: 600; font-size: 1.2rem; }
        .timer-container { font-size: 1.3rem; font-weight: 700; background: var(--medium-gray); padding: 8px 18px; border-radius: 25px; transition: color 0.3s, background-color 0.3s; }
        .header-controls { display: flex; gap: 10px; }
        .exam-body { display: flex; flex-grow: 1; min-height: 0; }

        /* --- Sidebar --- */
        .question-sidebar {
            width: 300px; background: var(--bg-color); border-right: 1px solid #dee2e6;
            display: flex; flex-direction: column; padding: 1rem; flex-shrink: 0;
        }
        .sidebar-header { margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 10px; background-color: var(--medium-gray); border-radius: 5px; overflow: hidden; margin-top: 0.5rem; }
        .progress-indicator { height: 100%; width: 0%; background-color: var(--success-color); transition: width var(--transition-speed) ease; }
        #question-list { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .question-item {
            padding: 10px 12px; /* Adjusted padding */ margin-bottom: 8px; background: var(--light-gray); border-left: 5px solid transparent;
            border-radius: var(--border-radius); cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        .question-item:hover { background-color: var(--medium-gray); border-left-color: var(--dark-gray); }
        .question-item.active { background-color: #e7f1ff; border-left-color: var(--primary-color); font-weight: 700; }
        .status-indicators { display: flex; align-items: center; gap: 8px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; border: 2px solid transparent; }
        .status-unattempted { background-color: #fff; border-color: var(--dark-gray); }
        .status-attempted { background-color: var(--warning-color); }
        .status-completed { background-color: var(--success-color); }
        .status-review { background-color: var(--review-color); }

        /* --- Main Content --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; padding: 0.8rem; /* Adjusted padding */ background-color: #f4f7f9; }
        .question-panel { padding: 1.5rem; background: var(--bg-color); border-radius: var(--border-radius); margin-bottom: 1rem; box-shadow: var(--box-shadow); }
        .panel-container { display: flex; flex-grow: 1; min-height: 0; gap: 1rem; }
        .panel { display: flex; flex-direction: column; background: var(--bg-color); border: 1px solid #dee2e6; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); }
        .editor-panel { flex-basis: 55%; }
        .output-panel { flex-basis: 45%; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; /* Adjusted padding */ background-color: var(--light-gray); border-bottom: 1px solid #dee2e6; }
        .panel-header h4 { margin: 0; font-size: 1rem; font-weight: 600; }
        .panel-header .editor-controls { display: flex; gap: 5px; }
        .CodeMirror { flex-grow: 1; height: auto; font-size: 16px; }
        #output-frame { flex-grow: 1; width: 100%; border: none; background: #fff; }
        .resizer { flex-basis: 10px; background: transparent; cursor: col-resize; flex-shrink: 0; position: relative; }
        .resizer::before { content: ''; position: absolute; left: 4px; top: 0; width: 2px; height: 100%; background: #dee2e6; }
        .main-footer { display: flex; justify-content: space-between; gap: 1rem; padding-top: 1rem; }
        .main-footer .left-actions { display: flex; gap: 1rem; }

        /* --- Modals --- */
        .modal-overlay {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; animation: fadeIn 0.3s;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background-color: var(--bg-color); padding: 1.75rem; /* Adjusted padding */ border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 550px; text-align: center;
            animation: slideIn 0.3s;
            max-height: 90vh; /* Limits height to 90% of viewport height */
            overflow-y: auto; /* Adds scrollbar if content overflows vertically */
        }
        .modal-actions { margin-top: 2rem; display: flex; justify-content: center; gap: 1rem; }

        /* --- Result Modal --- */
        .result-card {
            max-width: 800px;
            text-align: left;
            padding-right: 15px; /* Added space for scrollbar to avoid content being under it */
        }
        .result-header { color: var(--primary-color); margin-bottom: 1.5rem; text-align: center; }
        #results-breakdown table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
        #results-breakdown th, #results-breakdown td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #results-breakdown th { background-color: var(--light-gray); font-weight: 600; }
        .result-summary { text-align: center; border-top: 1px solid var(--medium-gray); padding-top: 1.5rem; }
        .result-summary .pass { color: var(--success-color); }
        .result-summary .fail { color: var(--danger-color); }
        .viva-section { margin-top: 2rem; }
        .viva-q { font-weight: bold; margin-top: 1rem; }
        .viva-a { margin-left: 1rem; padding-left: 1rem; border-left: 3px solid var(--medium-gray); margin-bottom: 1rem; /* Added margin for separation */ }
        .detailed-feedback-section .result-item {
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem; /* Increased margin for better separation */
            background-color: var(--light-gray);
        }
        .detailed-feedback-section .result-item hr {
            border: none;
            border-top: 1px dashed var(--medium-gray);
            margin: 1.5rem 0;
        }
        .detailed-feedback-section .result-item:last-child hr {
            display: none;
        }
        .detailed-feedback-section ul {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
        }
        .detailed-feedback-section ul li {
            margin-bottom: 0.75rem; /* Increased margin for better readability of list items */
        }
        .detailed-feedback-section ul li i {
            margin-right: 8px;
            vertical-align: middle; /* Vertically align icons */
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .exam-body { flex-direction: column; }
            .question-sidebar {
                width: 100%; height: auto; flex-direction: row; align-items: center;
                overflow-x: auto; padding: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            #question-list { display: flex; gap: 8px; flex-grow: 1; }
            .question-item { flex-shrink: 0; }
            .sidebar-header { display: none; }
            .panel-container { flex-direction: column; }
            .resizer { display: none; }
        }
        @media (max-width: 768px) {
            .exam-header .logo span { display: none; }
            .main-footer { flex-direction: column; gap: 0.5rem; }
            .main-footer .left-actions { justify-content: center; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            .auth-card { padding: 2rem 1.5rem; }
        }

        /* --- Print Styles --- */
        @media print {
            body * { visibility: hidden; }
            .modal-overlay, .modal-overlay * { visibility: visible; }
            #result-modal {
                position: absolute; left: 0; top: 0; width: 100%; max-width: 100%;
                box-shadow: none; border: 1px solid #ccc;
            }
            .modal-actions { display: none; }
        }
    </style>
</head>
<body>

    <!-- ======== LOGIN PAGE ======== -->
    <div id="login-page" class="page active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <img src="https://www.nielit.gov.in/sites/all/themes/berry/images/NIELIT-Logo.png" alt="NIELIT Logo">
                    <h2>O-Level Practical Exam Demo</h2>
                </div>
                <form id="loginForm" class="auth-form" novalidate>
                    <div class="form-group">
                        <label for="username">Enrollment Number e.g-(12345678)</label>
                        <input type="text" id="username" placeholder="e.g., 12345678" required aria-label="Username">
                        <div class="error-message" id="username-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="password">Password e.g-(Abc@123)</label>
                        <input type="password" id="password" placeholder="e.g., Abc@123" required aria-label="Password">
                        <div class="error-message" id="password-error"></div>
                    </div>
                    <p id="form-error" class="error-message"></p>
                    <button type="submit" class="btn btn-primary btn-full"><i class="fas fa-sign-in-alt"></i> Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ======== INSTRUCTIONS PAGE ======== -->
    <div id="instructions-page" class="page">
        <div class="auth-container">
            <div class="auth-card instructions-card">
                <div class="auth-header"> <h2><i class="fas fa-info-circle"></i> Exam Instructions</h2> </div>
                <div class="instructions-content">
                    <div class="instruction-item"><i class="fas fa-clock"></i><div><strong>Exam Duration:</strong> 50 minutes. The timer is in the top right corner and will turn red when time is low.</div></div>
                    <div class="instruction-item"><i class="fas fa-file-alt"></i><div><strong>Questions & Navigation:</strong> Use the left-side panel to navigate between questions. Your progress is shown above the question list.</div></div>
                    <div class="instruction-item"><i class="fas fa-tasks"></i><div><strong>Answering:</strong> Write your code in the editor. Use the "Run Code" button to test it in the output panel. You must click "Submit Answer" for your final code to be graded. Submitted answers cannot be changed.</div></div>
                    <div class="instruction-item"><i class="fas fa-star"></i><div><strong>Mark for Review:</strong> Use the "Mark for Review" button to flag questions you want to revisit.</div></div>
                    <div class="instruction-item"><i class="fas fa-power-off"></i><div><strong>Finishing the Exam:</strong> Click "End Exam" to finish and see your results. The exam will also end automatically when the timer reaches zero.</div></div>
                    <div class="instruction-item"><i class="fas fa-times-circle"></i><div><strong>Restrictions:</strong> Do not close the browser tab or navigate away. Your progress is saved locally, but it's best to complete the exam in one session.</div></div>
                </div>
                <div class="instructions-footer">
                    <div class="form-check">
                        <input type="checkbox" id="confirmInstructions" style="transform: scale(1.5);">
                        <label for="confirmInstructions">I have read and understood all the instructions.</label>
                    </div>
                    <button id="startExamBtn" class="btn btn-success" disabled><i class="fas fa-play-circle"></i> Start Exam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ======== EXAM PAGE ======== -->
    <div id="exam-page" class="page">
        <header class="exam-header">
            <div class="logo">
                <img src="https://www.nielit.gov.in/sites/all/themes/berry/images/NIELIT-Logo.png" alt="NIELIT Logo">
                <span>Web Designing & Publishing</span>
            </div>
            <div class="timer-container"><i class="fas fa-clock"></i> <span id="timer">50:00</span></div>
            <div class="header-controls">
                <button id="viewInstructionsBtn" class="btn btn-secondary"><i class="fas fa-info-circle"></i> Instructions</button>
                <button id="endExamBtn" class="btn btn-danger"><i class="fas fa-power-off"></i> End Exam</button>
            </div>
        </header>

        <div class="exam-body">
            <aside class="question-sidebar">
                <div class="sidebar-header">
                    <h3>Questions</h3>
                    <div class="progress-bar"><div id="progress-indicator" class="progress-indicator"></div></div>
                </div>
                <div id="question-list"></div>
            </aside>

            <main class="main-content" id="main-content">
                <div class="panel question-panel"><div id="question-display"></div></div>
                <div class="panel-container">
                    <div class="panel editor-panel">
                        <div class="panel-header">
                            <h4><i class="fas fa-code"></i> Code Editor</h4>
                            <div class="editor-controls">
                                <button id="fullscreenBtn" class="btn btn-icon" aria-label="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
                                <button id="themeToggleBtn" class="btn btn-icon" aria-label="Toggle Theme"><i class="fas fa-moon"></i></button>
                                <button id="zoomInBtn" class="btn btn-icon" aria-label="Zoom In"><i class="fas fa-search-plus"></i></button>
                                <button id="zoomOutBtn" class="btn btn-icon" aria-label="Zoom Out"><i class="fas fa-search-minus"></i></button>
                            </div>
                        </div>
                        <textarea id="code-editor"></textarea>
                    </div>
                    <div class="resizer" id="resizer"></div>
                    <div class="panel output-panel">
                        <div class="panel-header"><h4><i class="fas fa-eye"></i> Live Output</h4></div>
                        <iframe id="output-frame" sandbox="allow-scripts allow-same-origin" title="Output"></iframe>
                    </div>
                </div>
                <footer class="main-footer">
                    <div class="left-actions">
                        <button id="clearBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Clear Response</button>
                        <button id="reviewBtn" class="btn btn-warning"><i class="fas fa-star"></i> Mark for Review</button>
                    </div>
                    <div class="right-actions">
                        <button id="runBtn" class="btn btn-secondary"><i class="fas fa-play"></i> Run Code</button>
                        <button id="submitBtn" class="btn btn-success"><i class="fas fa-check-circle"></i> Submit Answer</button>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <!-- ======== MODALS ======== -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-body">Are you sure?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="modal-confirm-btn" class="btn">Confirm</button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
         <div class="modal-content result-card">
            <h2 class="result-header">Final Exam Results</h2>
            <div id="results-breakdown"></div>
            <div class="modal-actions">
                <button id="printResultsBtn" class="btn btn-secondary"><i class="fas fa-print"></i> Print Results</button>
                <button id="backToLoginBtn" class="btn btn-primary"><i class="fas fa-home"></i> Back to Login</button>
            </div>
        </div>
    </div>

    <!-- External Libraries: CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>

    <!-- ======== APPLICATION JAVASCRIPT ======== -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- PAGE NAVIGATION & SETUP ---
        const pages = document.querySelectorAll('.page');

        /**
         * Shows a specific page and hides all others.
         * @param {string} pageId - The ID of the page to show.
         */
        const showPage = (pageId) => {
            pages.forEach(page => {
                page.classList.remove('active');
                if (page.id === pageId) {
                    page.classList.add('active');
                }
            });
        };

        // --- LOGIN LOGIC ---
        document.getElementById('loginForm').addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default form submission
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const usernameError = document.getElementById('username-error');
            const passwordError = document.getElementById('password-error');
            const formError = document.getElementById('form-error');

            // Clear previous errors
            usernameError.textContent = '';
            passwordError.textContent = '';
            formError.textContent = '';

            let isValid = true;

            // Basic validation
            if (usernameInput.value.trim() === '') {
                usernameError.textContent = 'Enrollment number is required.';
                isValid = false;
            }
            if (passwordInput.value.trim() === '') {
                passwordError.textContent = 'Password is required.';
                isValid = false;
            }

            if (!isValid) return; // Stop if validation fails

            // Simulate authentication
            if (usernameInput.value === '12345678' && passwordInput.value === 'Abc@123') {
                showPage('instructions-page');
            } else {
                formError.textContent = 'Invalid credentials. Please try again.';
            }
        });

        // --- INSTRUCTIONS LOGIC ---
        const confirmCheck = document.getElementById('confirmInstructions');
        const startBtn = document.getElementById('startExamBtn');

        confirmCheck.addEventListener('change', () => {
            startBtn.disabled = !confirmCheck.checked;
        });

        startBtn.addEventListener('click', () => {
            if (confirmCheck.checked) {
                showPage('exam-page');
                initExam(); // Initialize the exam only once
            }
        });

        // --- GLOBAL EVENT LISTENERS ---
        document.getElementById('backToLoginBtn').addEventListener('click', () => {
            document.getElementById('result-modal').classList.remove('show');
            showPage('login-page');
            document.getElementById('loginForm').reset(); // Reset login form fields
            document.querySelectorAll('.error-message').forEach(el => el.textContent = ''); // Clear login errors
            confirmCheck.checked = false; // Uncheck instructions checkbox
            startBtn.disabled = true; // Disable start exam button
        });

        document.getElementById('printResultsBtn').addEventListener('click', () => window.print());

        // --- EXAM LOGIC ---
        let examInitialized = false;
        let editor; // CodeMirror editor instance

        /**
         * Initializes the exam environment. Called only once when the exam starts.
         */
        const initExam = () => {
            if (examInitialized) return; // Prevent re-initialization

            // --- EXAM DATA (Questions and Evaluation Criteria) ---
            const questions = [
                 {
                    year: "Q1", task: "Write an HTML code using CSS to create a job application form having the following details:\n(I) Personal Information (First Name, Middle Name, Last Name, Gender, Address & Phone Number)\n(II) Education Details (10th, 12th, Graduation & others)\n(III) Experience (in months)", marks: 25,
                    evaluation: [
                        { type: 'tag', value: 'form', points: 2, feedback: 'Form element is missing.' },
                        { type: 'tag', value: 'fieldset', points: 3, feedback: 'Fieldset for grouping information is missing.' },
                        { type: 'tag', value: 'legend', points: 2, feedback: 'Legend for fieldsets is missing.' },
                        { type: 'tag', value: 'input type="text"', points: 3, feedback: 'Text input fields (First Name, Middle Name, Last Name, Address) are missing.' },
                        { type: 'tag', value: 'input type="radio"', points: 2, feedback: 'Radio buttons for Gender are missing.' },
                        { type: 'tag', value: 'input type="tel"', points: 2, feedback: 'Phone number input field (type="tel") is missing.' },
                        { type: 'tag', value: 'textarea', points: 1, feedback: 'Textarea for Address is missing.' }, // Added textarea check for address clarity
                        { type: 'tag', value: 'select', points: 2, feedback: 'Select element for Education (e.g., Graduation/Others) is missing.' },
                        { type: 'tag', value: 'input type="number"', points: 2, feedback: 'Number input for Experience (in months) is missing.' },
                        { type: 'css', value: 'label { display:', points: 2, feedback: 'Labels are not styled for proper display (e.g., block/inline-block).' } // Generic check for label display
                    ],
                    viva: [
                        { q: "What is the purpose of the `<fieldset>` and `<legend>` tags in a form?", a: "`<fieldset>` is used to group related elements in a form, and `<legend>` provides a caption for the `<fieldset>`." },
                        { q: "Explain the difference between `type='radio'` and `type='checkbox'` for input fields.", a: "Radio buttons allow only one choice from a set, while checkboxes allow multiple choices." },
                        { q: "How can you ensure better accessibility for form inputs?", a: "By using the `<label>` tag with a `for` attribute linked to the input's `id`, and by using semantic HTML5 input types." }
                    ]
                },
                {
                    year: "Q2", task: "Create a webpage, divide the webpage into six frames. In one frame create five links that will display different HTML forms in the remaining five frames respectively.", marks: 20,
                    evaluation: [
                        { type: 'tag', value: 'frameset', points: 5, feedback: 'Frameset structure is missing.' },
                        { type: 'tag', value: 'frame', points: 5, feedback: 'At least six frame elements are not defined.' },
                        { type: 'tag', value: 'a', points: 3, feedback: 'Anchor (link) elements are missing.' },
                        { type: 'css', value: 'target=', points: 4, feedback: 'Links are not using the `target` attribute to specify frame display.' },
                        { type: 'html', value: 'src=', points: 3, feedback: 'Frame `src` attributes are not specified.' } // Checks if src attribute is used for frames
                    ],
                    viva: [
                        { q: "What is a `frameset` and how does it work?", a: "A `frameset` divides the browser window into multiple rectangular regions (frames), each capable of loading a separate HTML document." },
                        { q: "Explain the `target` attribute in the context of frames.", a: "The `target` attribute in an `<a>` tag specifies the name of the frame or window where the linked document should be opened." },
                        { q: "Why are HTML framesets generally discouraged in modern web development?", a: "They have accessibility issues, make bookmarking difficult, can complicate printing, and are replaced by `<iframe>` for embedding or CSS layouts (Flexbox/Grid) for structuring content." }
                    ]
                },
                 {
                    year: "Q3", task: "Design an HTML page to display a picture. The picture should be removed from the screen after a user clicks with a mouse on the picture.", marks: 15,
                    evaluation: [
                        { type: 'tag', value: 'img', points: 4, feedback: 'Image element is missing.' },
                        { type: 'js', value: 'addEventListener\\([\'"]click[\'"]', points: 5, feedback: 'Click event listener is not implemented on the image.' },
                        { type: 'js', value: '\\.remove\\(\\)', points: 4, feedback: 'Method to remove the element (e.g., `.remove()`) is missing.' },
                        { type: 'js', value: 'function\\s*\\([\\w\\s]*\\)', points: 2, feedback: 'Event handler function is not properly defined.' } // General check for a function as event handler
                    ],
                    viva: [
                        { q: "How do you attach an event listener to an HTML element in JavaScript?", a: "Using `element.addEventListener('event', functionName);` where 'event' is like 'click' or 'mouseover'." },
                        { q: "What is the difference between `element.remove()` and `element.style.display = 'none'`?", a: "`.remove()` completely deletes the element from the DOM. `style.display = 'none'` only hides the element, but it remains in the DOM structure." },
                        { q: "What are some common image formats used on the web?", a: "JPEG (for photos), PNG (for transparency and graphics), GIF (for animation), and WebP (modern, efficient format)." }
                    ]
                },
                {
                    year: "Q4", task: "Create an HTML page with a blinking warning in a red background having a message 'warning' in large size. Add moving text 'read the message' below it.", marks: 20,
                    evaluation: [
                        { type: 'html', value: 'warning', points: 2, feedback: 'The text "warning" is missing.' },
                        { type: 'html', value: 'read the message', points: 2, feedback: 'The text "read the message" is missing.' },
                        { type: 'css', value: 'background-color:\\s*red', points: 3, feedback: 'Red background color for the warning is missing.' },
                        { type: 'css', value: 'font-size:\\s*[^;]*large', points: 3, feedback: 'Large font size for the warning is missing.' },
                        { type: 'css', value: '@keyframes\\s+blink', points: 4, feedback: 'CSS keyframes for blinking animation are not defined.' },
                        { type: 'css', value: 'animation:\\s*blink', points: 2, feedback: 'Blinking animation is not applied to the warning.' },
                        { type: 'css', value: '@keyframes\\s+moveText', points: 2, feedback: 'CSS keyframes for moving text animation are not defined.' },
                        { type: 'css', value: 'animation:\\s*moveText', points: 2, feedback: 'Moving text animation is not applied.' }
                    ],
                     viva: [
                        { q: "How do you create a CSS animation?", a: "You define animation steps using `@keyframes` (e.g., changing properties like `opacity`, `transform`, `left`), and then apply the animation to an element using the `animation` property." },
                        { q: "What is the difference between `animation-duration` and `animation-iteration-count`?", a: "`animation-duration` sets how long one cycle of the animation takes, while `animation-iteration-count` specifies how many times the animation should play (e.g., `infinite` for continuous)." },
                        { q: "What was the traditional HTML tag for moving text, and why is it deprecated?", a: "The `<marquee>` tag was traditionally used. It is deprecated because it causes accessibility issues, is not semantic, and its behavior can be replicated with CSS animations for better control and performance." }
                    ]
                }
            ];

            // --- DOM Elements Cache ---
            const elements = {
                timer: document.getElementById('timer'),
                questionList: document.getElementById('question-list'),
                progressIndicator: document.getElementById('progress-indicator'),
                questionDisplay: document.getElementById('question-display'),
                outputFrame: document.getElementById('output-frame'),
                runBtn: document.getElementById('runBtn'),
                submitBtn: document.getElementById('submitBtn'),
                themeToggleBtn: document.getElementById('themeToggleBtn'),
                zoomInBtn: document.getElementById('zoomInBtn'),
                zoomOutBtn: document.getElementById('zoomOutBtn'),
                endExamBtn: document.getElementById('endExamBtn'),
                modal: document.getElementById('custom-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalConfirmBtn: document.getElementById('modal-confirm-btn'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
                resultModal: document.getElementById('result-modal'),
                resultsBreakdown: document.getElementById('results-breakdown'),
                clearBtn: document.getElementById('clearBtn'),
                reviewBtn: document.getElementById('reviewBtn'),
                viewInstructionsBtn: document.getElementById('viewInstructionsBtn'),
                fullscreenBtn: document.getElementById('fullscreenBtn')
            };

            // --- State Management ---
            // timeLeft is in seconds (50 minutes * 60 seconds/minute)
            let state = {
                activeQuestionIndex: 0,
                timeLeft: 3000,
                timerInterval: null,
                answers: [],
                editorTheme: 'eclipse',
                fontSize: 16
            };

            // --- CodeMirror Editor Instance ---
            editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: 'htmlmixed',
                lineNumbers: true,
                theme: state.editorTheme,
                lineWrapping: true,
                autofocus: true,
                extraKeys: { "Ctrl-Space": "autocomplete" }
            });

            /**
             * Loads exam state from localStorage or initializes default state.
             */
            const loadState = () => {
                const savedState = localStorage.getItem('nielitExamState');
                if (savedState) {
                    try {
                        const parsedState = JSON.parse(savedState);
                        // Ensure compatibility if questions array structure changes or new questions are added
                        if (parsedState.answers && parsedState.answers.length === questions.length) {
                             Object.assign(state, parsedState);
                        } else {
                            console.warn("Saved state incompatible, initializing new state.");
                            initializeAnswers();
                        }
                    } catch (e) {
                        console.error("Error parsing saved state:", e);
                        initializeAnswers(); // Fallback to fresh state
                    }
                } else {
                    initializeAnswers();
                }
            };

            /**
             * Initializes the answers array based on the number of questions.
             */
            const initializeAnswers = () => {
                state.answers = questions.map(() => ({ code: '', status: 'unattempted' }));
            };

            /**
             * Saves the current exam state to localStorage.
             */
            const saveState = () => {
                if (state.answers[state.activeQuestionIndex]) {
                    state.answers[state.activeQuestionIndex].code = editor.getValue();
                }
                try {
                    localStorage.setItem('nielitExamState', JSON.stringify(state));
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                    // Optionally alert user about persistent storage issue
                }
            };

            /**
             * Starts the exam timer.
             */
            const startTimer = () => {
                if (state.timerInterval) clearInterval(state.timerInterval); // Clear any existing timer
                state.timerInterval = setInterval(() => {
                    state.timeLeft--;
                    updateTimerDisplay();
                    // Save state periodically to prevent data loss
                    if (state.timeLeft % 10 === 0) { // Save every 10 seconds
                        saveState();
                    }
                    if (state.timeLeft <= 0) {
                        endExam(true); // End exam automatically when time runs out
                    }
                }, 1000); // Update every second
            };

            /**
             * Updates the timer display and applies styling based on time left.
             */
            const updateTimerDisplay = () => {
                if (state.timeLeft < 0) {
                    state.timeLeft = 0; // Ensure timer doesn't go negative on display
                }
                const minutes = Math.floor(state.timeLeft / 60);
                const seconds = state.timeLeft % 60;
                elements.timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                const timerContainer = elements.timer.parentElement;
                if (state.timeLeft <= 300) { // Less than or equal to 5 minutes
                    timerContainer.style.color = 'white';
                    timerContainer.style.backgroundColor = 'var(--danger-color)';
                } else {
                    timerContainer.style.color = 'var(--text-color)';
                    timerContainer.style.backgroundColor = 'var(--medium-gray)';
                }
            };

            /**
             * Renders the list of questions in the sidebar.
             */
            const renderQuestionList = () => {
                elements.questionList.innerHTML = ''; // Clear existing list
                questions.forEach((q, index) => {
                    const item = document.createElement('div');
                    const answer = state.answers[index];
                    item.className = `question-item ${index === state.activeQuestionIndex ? 'active' : ''}`;
                    item.innerHTML = `<span>Q${index + 1}: ${q.year}</span><div class="status-indicators"><span class="status-indicator status-${answer.status}" title="${answer.status}"></span></div>`;
                    item.onclick = () => selectQuestion(index);
                    elements.questionList.appendChild(item);
                });
                updateProgress();
            };

            /**
             * Selects and displays a specific question.
             * @param {number} index - The index of the question to select.
             */
            const selectQuestion = (index) => {
                // Save current question's code before switching, unless it's the very first load
                if (state.answers[state.activeQuestionIndex] && editor) {
                    saveState();
                }

                state.activeQuestionIndex = index;
                const question = questions[index];
                const answer = state.answers[index];

                elements.questionDisplay.innerHTML = `<h3>Question ${index + 1} <small>(${question.year})</small></h3><p>${question.task}</p><p><strong>Marks: ${question.marks}</strong></p>`;
                editor.setValue(answer.code);
                editor.clearHistory(); // Clear undo/redo history for new question
                editor.focus(); // Focus the editor for immediate typing

                // Disable submit button if question is already completed
                elements.submitBtn.disabled = answer.status === 'completed';
                renderQuestionList(); // Re-render question list to update active state
            };

            /**
             * Updates the progress bar based on attempted/completed questions.
             */
            const updateProgress = () => {
                const attemptedOrCompletedCount = state.answers.filter(a => a.status === 'completed' || a.status === 'attempted' || a.status === 'review').length;
                elements.progressIndicator.style.width = `${(attemptedOrCompletedCount / questions.length) * 100}%`;
            };

            /**
             * Runs the code in the editor and displays the output in the iframe.
             */
            const runCode = () => {
                elements.runBtn.disabled = true;
                elements.runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';

                const iframeDoc = elements.outputFrame.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(editor.getValue()); // Write user's code to iframe
                iframeDoc.close();

                // Re-enable button after a short delay for visual feedback
                setTimeout(() => {
                    elements.runBtn.disabled = false;
                    elements.runBtn.innerHTML = '<i class="fas fa-play"></i> Run Code';
                }, 700);
            };
            
            /**
             * Marks the current question for review.
             */
            const markForReview = () => {
                const currentAnswer = state.answers[state.activeQuestionIndex];
                if (currentAnswer.status === 'completed') {
                    alert('You cannot mark a submitted question for review.');
                    return;
                }
                currentAnswer.status = 'review';
                renderQuestionList();
                saveState();
            };
            
            /**
             * Clears the current question's response in the editor.
             */
            const clearResponse = () => {
                const currentAnswer = state.answers[state.activeQuestionIndex];
                if (currentAnswer.status === 'completed') {
                    alert('You cannot clear the response for a submitted question.');
                    return;
                }
                showModal(
                    'Clear Response',
                    `Are you sure you want to clear your code for Question ${state.activeQuestionIndex + 1}? This action cannot be undone.`,
                    () => {
                        editor.setValue(''); // Clear editor content
                        currentAnswer.code = ''; // Also clear from state
                        currentAnswer.status = 'unattempted'; // Reset status
                        renderQuestionList();
                        saveState();
                    },
                    'btn-danger'
                );
            };

            /**
             * Submits the answer for the current question.
             */
            const submitAnswer = () => {
                if (editor.getValue().trim() === '') {
                    alert('Cannot submit an empty answer. Please write some code.');
                    return;
                }
                showModal(
                    'Confirm Submission',
                    `Are you sure you want to submit Question ${state.activeQuestionIndex + 1}? You won't be able to edit it again after submission.`,
                    () => {
                        const currentIndex = state.activeQuestionIndex;
                        state.answers[currentIndex].status = 'completed';
                        elements.submitBtn.disabled = true; // Disable submit button for this question
                        renderQuestionList();
                        saveState();
                    },
                    'btn-success'
                );
            };

            /**
             * Ends the exam, either by user action or automatically.
             * @param {boolean} isAutoSubmit - True if the exam is ending due to timer.
             */
            const endExam = (isAutoSubmit = false) => {
                clearInterval(state.timerInterval); // Stop the timer

                const performEnd = () => {
                    saveState(); // Ensure last changes are saved
                    evaluateAndShowResults();
                    localStorage.removeItem('nielitExamState'); // Clear saved state
                    examInitialized = false; // Allow re-initialization if starting a new exam
                };

                if (isAutoSubmit) {
                    performEnd(); // No confirmation needed for auto-submit
                } else {
                    showModal('End Exam', 'Are you sure you want to end the exam? All attempted answers will be evaluated.', performEnd, 'btn-danger');
                }
            };
            
            /**
             * Evaluates all submitted answers and displays the results in a modal.
             */
            const evaluateAndShowResults = () => {
                let totalScore = 0;
                let totalMarks = 0;
                let detailedResultsHTML = ''; // Holds detailed feedback per question
                let questionsTableRows = ''; // Holds rows for the summary table

                questions.forEach((q, index) => {
                    totalMarks += q.marks;
                    const answer = state.answers[index];
                    let questionScore = 0;
                    let feedbackItems = '';
                    // Only evaluate if question was attempted (had content) or explicitly submitted
                    let hasAttempted = answer.code.trim() !== '';

                    if (hasAttempted) {
                        q.evaluation.forEach(crit => {
                            let isMet = false;
                            let regex;

                            try {
                                if (crit.type === 'tag') {
                                    regex = new RegExp(`<${crit.value}\\b`, 'i');
                                } else if (crit.type === 'css') {
                                    const parts = crit.value.split(':').map(s => s.trim());
                                    if (parts.length === 2) {
                                        const [prop, val] = parts;
                                        // Escape special regex characters in property and value
                                        const escapedProp = prop.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                                        const escapedVal = val.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                                        // Match property: value with optional whitespace and semicolon
                                        regex = new RegExp(`${escapedProp}\\s*:\\s*${escapedVal}\\s*;?`, 'i');
                                    } else {
                                        // For general CSS rules like '@media' or 'display:flex' without specific value
                                        regex = new RegExp(crit.value.replace(/\s+/g, '\\s*'), 'i');
                                    }
                                } else if (crit.type === 'js') {
                                    // Try to use crit.value directly if it's already a regex string (e.g., from /.source)
                                    regex = new RegExp(crit.value, 'i');
                                }
                                isMet = regex.test(answer.code);
                            } catch (e) {
                                console.error(`Error creating regex for criterion value "${crit.value}":`, e);
                                // Fallback for invalid regex string: treat as plain string match
                                const escapedValue = crit.value.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                                regex = new RegExp(escapedValue, 'i');
                                isMet = regex.test(answer.code);
                            }
                            
                            if (isMet) {
                                questionScore += crit.points;
                                // Remove " not" if present for positive feedback
                                feedbackItems += `<li class="pass"><i class="fas fa-check-circle"></i> Met criterion: ${crit.feedback.replace(' not', '')} (+${crit.points})</li>`;
                            } else {
                                feedbackItems += `<li class="fail"><i class="fas fa-times-circle"></i> ${crit.feedback}</li>`;
                            }
                        });
                    } else {
                        feedbackItems += '<li class="info"><i class="fas fa-info-circle"></i> Not Attempted</li>';
                    }
                    
                    totalScore += questionScore;
                    
                    // Add row to the summary table
                    questionsTableRows += `
                        <tr>
                            <td>Q${index + 1} (${q.year})</td>
                            <td>${answer.status === 'completed' ? 'Submitted' : (hasAttempted ? 'Attempted' : 'Not Attempted')}</td>
                            <td>${questionScore} / ${q.marks}</td>
                        </tr>
                    `;

                    // Prepare detailed feedback section for below the table
                    let vivaHTML = '<div class="viva-section"><h4><i class="fas fa-microphone-alt"></i> Viva Voce Insights</h4>';
                    q.viva.forEach(v => {
                        vivaHTML += `<p class="viva-q"><i class="fas fa-comment-dots"></i> Q: ${v.q}</p><p class="viva-a">A: ${v.a}</p>`;
                    });
                    vivaHTML += '</div>';

                    detailedResultsHTML += `
                        <div class="result-item">
                            <h4>Detailed Feedback for Q${index + 1}: ${q.year}</h4>
                            <div><strong>Evaluation Feedback:</strong><ul>${feedbackItems}</ul></div>
                            ${vivaHTML}
                            <hr>
                        </div>
                    `;
                });

                const percentage = totalMarks > 0 ? (totalScore / totalMarks) * 100 : 0;
                const passStatus = percentage >= 50 ? "Pass" : "Fail";
                let summaryHTML = `
                    <div class="result-summary">
                        <h3>Total Score: ${totalScore} / ${totalMarks} (${percentage.toFixed(2)}%)</h3>
                        <h2 class="final-status ${passStatus.toLowerCase()}">Final Status: ${passStatus}</h2>
                    </div>
                `;

                let fullResultsContent = `
                    ${summaryHTML}
                    <h3>Question-wise Score Summary</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Status</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${questionsTableRows}
                        </tbody>
                    </table>
                    <div class="detailed-feedback-section">
                        <h3>Detailed Question Feedback & Viva Insights</h3>
                        ${detailedResultsHTML}
                    </div>
                `;
                
                elements.resultsBreakdown.innerHTML = fullResultsContent;
                elements.resultModal.classList.add('show'); // Display the result modal
            };

            /**
             * Displays a custom confirmation modal.
             * @param {string} title - The title of the modal.
             * @param {string} body - The HTML content for the modal body.
             * @param {function} onConfirm - Callback function to execute on confirm.
             * @param {string} confirmClass - CSS class for the confirm button (e.g., 'btn-primary', 'btn-danger').
             */
            const showModal = (title, body, onConfirm, confirmClass = 'btn-primary') => {
                elements.modalTitle.textContent = title;
                elements.modalBody.innerHTML = body;

                // Reset modal buttons and width before showing for consistent behavior
                elements.modalConfirmBtn.textContent = 'Confirm';
                elements.modalCancelBtn.style.display = 'inline-flex'; // Show cancel by default
                elements.modal.querySelector('.modal-content').style.maxWidth = '550px'; // Restore default width

                elements.modal.classList.add('show');

                // Clone and replace the confirm button to effectively remove all previous event listeners
                // This is a robust way to ensure only the new `onConfirm` handler is active.
                const newConfirmBtn = elements.modalConfirmBtn.cloneNode(true);
                elements.modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, elements.modalConfirmBtn);
                elements.modalConfirmBtn = newConfirmBtn;
                
                elements.modalConfirmBtn.className = `btn ${confirmClass}`; // Apply specific style
                
                newConfirmBtn.onclick = () => { // Attach the new handler
                    elements.modal.classList.remove('show');
                    onConfirm(); // Execute the provided callback
                };
            };

            /**
             * Toggles the CodeMirror editor theme.
             */
            const updateThemeIcon = () => {
                elements.themeToggleBtn.querySelector('i').className = state.editorTheme === 'dracula' ? 'fas fa-sun' : 'fas fa-moon';
            };

            /**
             * Changes the font size of the CodeMirror editor.
             * @param {number} delta - The amount to change the font size by (e.g., 1 or -1).
             */
            const changeFontSize = (delta) => {
                state.fontSize = Math.max(10, Math.min(30, state.fontSize + delta)); // Clamp font size
                editor.getWrapperElement().style.fontSize = `${state.fontSize}px`;
                editor.refresh(); // Refresh CodeMirror to apply style changes correctly
                saveState();
            };

            /**
             * Toggles fullscreen mode for the main content area.
             */
            const toggleFullscreen = () => {
                const mainContent = document.getElementById('main-content');
                if (!document.fullscreenElement) {
                    mainContent.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        alert(`Could not enter fullscreen: ${err.message}`);
                    });
                    elements.fullscreenBtn.querySelector('i').className = 'fas fa-compress'; // Change icon to 'compress'
                } else {
                    document.exitFullscreen();
                    elements.fullscreenBtn.querySelector('i').className = 'fas fa-expand'; // Change icon to 'expand'
                }
            };
            
            // --- Event Listeners for Exam Page Controls ---
            elements.runBtn.addEventListener('click', runCode);
            elements.submitBtn.addEventListener('click', submitAnswer);
            elements.endExamBtn.addEventListener('click', () => endExam(false)); // False for user-initiated end
            elements.reviewBtn.addEventListener('click', markForReview);
            elements.clearBtn.addEventListener('click', clearResponse);

            elements.themeToggleBtn.addEventListener('click', () => {
                state.editorTheme = state.editorTheme === 'eclipse' ? 'dracula' : 'eclipse';
                editor.setOption('theme', state.editorTheme);
                updateThemeIcon();
                saveState();
            });

            elements.zoomInBtn.addEventListener('click', () => changeFontSize(1));
            elements.zoomOutBtn.addEventListener('click', () => changeFontSize(-1));
            elements.modalCancelBtn.addEventListener('click', () => elements.modal.classList.remove('show')); // Simply hide modal on cancel
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);

            elements.viewInstructionsBtn.addEventListener('click', () => {
                // Manually construct the clean instructions HTML for the modal
                // This ensures the modal content is always pristine instructions without dynamic exam data
                const instructionsModalContent = `
                    <div class="instruction-item"><i class="fas fa-clock"></i><div><strong>Exam Duration:</strong> 50 minutes. The timer is in the top right corner and will turn red when time is low.</div></div>
                    <div class="instruction-item"><i class="fas fa-file-alt"></i><div><strong>Questions & Navigation:</strong> Use the left-side panel to navigate between questions. Your progress is shown above the question list.</div></div>
                    <div class="instruction-item"><i class="fas fa-tasks"></i><div><strong>Answering:</strong> Write your code in the editor. Use the "Run Code" button to test it in the output panel. You must click "Submit Answer" for your final code to be graded. Submitted answers cannot be changed.</div></div>
                    <div class="instruction-item"><i class="fas fa-star"></i><div><strong>Mark for Review:</strong> Use the "Mark for Review" button to flag questions you want to revisit.</div></div>
                    <div class="instruction-item"><i class="fas fa-power-off"></i><div><strong>Finishing the Exam:</strong> Click "End Exam" to finish and see your results. The exam will also end automatically when the timer reaches zero.</div></div>
                    <div class="instruction-item"><i class="fas fa-times-circle"></i><div><strong>Restrictions:</strong> Do not close the browser tab or navigate away. Your progress is saved locally, but it's best to complete the exam in one session.</div></div>
                `;
                elements.modal.querySelector('.modal-content').style.maxWidth = '700px'; // Adjust modal width for instructions
                showModal('Exam Instructions', instructionsModalContent, () => { /* No specific action on confirm, just close */ }, 'btn-primary');
                elements.modalConfirmBtn.textContent = 'Close'; // Change button text
                elements.modalCancelBtn.style.display = 'none'; // Hide cancel button for instructions modal
            });

            // Add a transitionend listener to reset modal state after it closes (for showModal)
            elements.modal.addEventListener('transitionend', (event) => {
                // Ensure the event is for opacity change and modal is truly hidden
                if (event.propertyName === 'opacity' && !elements.modal.classList.contains('show')) {
                    elements.modalConfirmBtn.textContent = 'Confirm'; // Restore default text
                    elements.modalCancelBtn.style.display = 'inline-flex'; // Restore default display
                    elements.modal.querySelector('.modal-content').style.maxWidth = '550px'; // Restore default width
                }
            });

            // Update question status when editor content changes
            editor.on('change', () => {
                const currentAnswer = state.answers[state.activeQuestionIndex];
                if (currentAnswer.status === 'unattempted' || currentAnswer.status === 'review') {
                    if (editor.getValue().trim() !== '') {
                        currentAnswer.status = 'attempted';
                        renderQuestionList(); // Update sidebar status indicator
                    } else {
                        // If user clears the code, revert to unattempted
                        currentAnswer.status = 'unattempted';
                        renderQuestionList();
                    }
                }
            });

            // --- Initializer Call ---
            loadState(); // Load saved state or initialize
            editor.setOption('theme', state.editorTheme); // Apply saved theme
            editor.getWrapperElement().style.fontSize = `${state.fontSize}px`; // Apply saved font size
            editor.refresh(); // Important for CodeMirror to correctly render after style changes
            updateThemeIcon(); // Set correct theme icon
            selectQuestion(state.activeQuestionIndex); // Load the active question
            startTimer(); // Start the exam timer
            updateTimerDisplay(); // Initial timer display update

            examInitialized = true; // Mark exam as initialized
        };

        // --- RESIZABLE PANEL LOGIC ---
        const resizer = document.getElementById('resizer');
        const editorPanel = document.querySelector('.editor-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            // Add event listeners to the document to handle mousemove and mouseup
            // This allows resizing even if the mouse leaves the resizer element
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            // Prevent text selection during resize
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'col-resize';
        });

        function resize(e) {
            if (!isResizing) return;
            const parent = resizer.parentElement;
            // Calculate new width for the editor panel based on mouse position
            const newWidth = e.clientX - parent.getBoundingClientRect().left;
            
            // Set bounds for resizing to prevent panels from becoming too small
            const minPanelWidth = 200; // Minimum width for each panel
            if (newWidth > minPanelWidth && newWidth < parent.offsetWidth - minPanelWidth) {
                editorPanel.style.flexBasis = newWidth + 'px';
                editor.refresh(); // Important to refresh CodeMirror when its container size changes
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
            // Reset body styles
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
        }
    });
    </script>

</body>
</html>
